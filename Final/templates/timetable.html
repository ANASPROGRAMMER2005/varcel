{% extends "base.html" %}

{% block title %}Timetable - CampusLink{% endblock %}

{% block content %}
<div class="page-container">
    <div class="page-header">
        <div class="header-content">
            <h1><i class="fas fa-calendar"></i> My Timetable</h1>
            <p>Manage your weekly class schedule and stay organized</p>
        </div>
        <button class="btn btn-primary" onclick="openClassModal()">
            <i class="fas fa-plus"></i> Add Class
        </button>
    </div>

    <!-- Timetable View Toggle -->
    <div class="view-toggle">
        <button class="toggle-btn active" onclick="switchView('grid')" id="gridViewBtn">
            <i class="fas fa-th"></i> Grid View
        </button>
        <button class="toggle-btn" onclick="switchView('list')" id="listViewBtn">
            <i class="fas fa-list"></i> List View
        </button>
    </div>

    <!-- Grid View -->
    <div id="gridView" class="timetable-container">
        <div class="timetable-grid">
            <div class="time-header">Time</div>
            <div class="day-header">Monday</div>
            <div class="day-header">Tuesday</div>
            <div class="day-header">Wednesday</div>
            <div class="day-header">Thursday</div>
            <div class="day-header">Friday</div>
            <div class="day-header">Saturday</div>
            <div class="day-header">Sunday</div>

            <!-- Time slots will be generated by JavaScript -->
            <div id="timeSlots"></div>
        </div>
    </div>

    <!-- List View -->
    <div id="listView" class="list-container" style="display: none;">
        <div class="day-tabs">
            <button class="day-tab active" onclick="switchDay('Monday')" data-day="Monday">Mon</button>
            <button class="day-tab" onclick="switchDay('Tuesday')" data-day="Tuesday">Tue</button>
            <button class="day-tab" onclick="switchDay('Wednesday')" data-day="Wednesday">Wed</button>
            <button class="day-tab" onclick="switchDay('Thursday')" data-day="Thursday">Thu</button>
            <button class="day-tab" onclick="switchDay('Friday')" data-day="Friday">Fri</button>
            <button class="day-tab" onclick="switchDay('Saturday')" data-day="Saturday">Sat</button>
            <button class="day-tab" onclick="switchDay('Sunday')" data-day="Sunday">Sun</button>
        </div>
        <div id="daySchedule" class="day-schedule">
            <!-- Day schedule will be populated by JavaScript -->
        </div>
    </div>
</div>

<!-- Add/Edit Class Modal -->
<div id="classModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle">Add New Class</h3>
            <button class="modal-close" onclick="closeClassModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form id="classForm" class="modal-form">
            <div class="form-row">
                <div class="form-group">
                    <label for="classDay">Day *</label>
                    <select id="classDay" name="day" required>
                        <option value="">Select Day</option>
                        <option value="Monday">Monday</option>
                        <option value="Tuesday">Tuesday</option>
                        <option value="Wednesday">Wednesday</option>
                        <option value="Thursday">Thursday</option>
                        <option value="Friday">Friday</option>
                        <option value="Saturday">Saturday</option>
                        <option value="Sunday">Sunday</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="classTime">Time *</label>
                    <input type="time" id="classTime" name="time" required>
                </div>
            </div>

            <div class="form-group">
                <label for="classSubject">Subject/Course *</label>
                <input type="text" id="classSubject" name="subject" required placeholder="e.g., Mathematics, Computer Science">
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="classRoom">Room/Location *</label>
                    <input type="text" id="classRoom" name="room" required placeholder="e.g., Room 101, Lab A">
                </div>

                <div class="form-group">
                    <label for="classProfessor">Professor/Instructor</label>
                    <input type="text" id="classProfessor" name="professor" placeholder="Professor name">
                </div>
            </div>

            <div class="form-group">
                <label for="classDuration">Duration (minutes)</label>
                <select id="classDuration" name="duration">
                    <option value="60">1 hour</option>
                    <option value="90">1.5 hours</option>
                    <option value="120">2 hours</option>
                    <option value="180">3 hours</option>
                </select>
            </div>

            <div class="form-group">
                <label for="classNotes">Notes</label>
                <textarea id="classNotes" name="notes" placeholder="Additional notes about this class..." rows="3"></textarea>
            </div>

            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeClassModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> Save Class
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Class Details Modal -->
<div id="classDetailsModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="detailsTitle">Class Details</h3>
            <button class="modal-close" onclick="closeClassDetailsModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div id="classDetailsContent" class="modal-form">
            <!-- Content will be populated by JavaScript -->
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let timetableData = { schedule: [] };
let currentView = 'grid';
let currentDay = 'Monday';
let editingClass = null;

const timeSlots = [
    '08:00', '09:00', '10:00', '11:00', '12:00', 
    '13:00', '14:00', '15:00', '16:00', '17:00', '18:00'
];

const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];

document.addEventListener('DOMContentLoaded', function() {
    loadTimetable();
    generateTimeSlots();
});

async function loadTimetable() {
    try {
        const response = await fetch('/api/timetable?user_id=default');
        const data = await response.json();
        
        // Ensure schedule is always an array
        timetableData = {
            schedule: Array.isArray(data.schedule) ? data.schedule : []
        };
        
        if (currentView === 'grid') {
            displayGridView();
        } else {
            displayListView();
        }
    } catch (error) {
        console.error('Error loading timetable:', error);
        timetableData = { schedule: [] };
        showNotification('Error loading timetable. Please try again.', 'error');
        
        // Still display the empty timetable
        if (currentView === 'grid') {
            displayGridView();
        } else {
            displayListView();
        }
    }
}

function generateTimeSlots() {
    const timeSlotsContainer = document.getElementById('timeSlots');
    let slotsHTML = '';

    timeSlots.forEach(time => {
        slotsHTML += `<div class="time-slot">${time}</div>`;
        
        days.forEach(day => {
            const classData = findClassAtTime(day, time);
            if (classData) {
                slotsHTML += `
                    <div class="class-slot filled" onclick="viewClassDetails('${classData.id}')">
                        <div class="class-subject">${classData.subject}</div>
                        <div class="class-room">${classData.room}</div>
                        <div class="class-professor">${classData.professor || ''}</div>
                    </div>
                `;
            } else {
                slotsHTML += `
                    <div class="class-slot empty" onclick="addClassAtTime('${day}', '${time}')">
                        <i class="fas fa-plus"></i>
                    </div>
                `;
            }
        });
    });

    timeSlotsContainer.innerHTML = slotsHTML;
}

function findClassAtTime(day, time) {
    if (!timetableData.schedule) return null;
    
    const classItem = timetableData.schedule.find(item => 
        item.day === day && item.time === time
    );
    
    return classItem ? { ...classItem, id: timetableData.schedule.indexOf(classItem) } : null;
}

function displayGridView() {
    generateTimeSlots();
}

function displayListView() {
    displayDaySchedule(currentDay);
}

function displayDaySchedule(day) {
    const container = document.getElementById('daySchedule');
    const dayClasses = timetableData.schedule ? 
        timetableData.schedule.filter(item => item.day === day).sort((a, b) => a.time.localeCompare(b.time)) : [];

    if (dayClasses.length === 0) {
        container.innerHTML = `
            <div class="empty-day">
                <i class="fas fa-calendar-times"></i>
                <h3>No classes scheduled for ${day}</h3>
                <p>Click "Add Class" to schedule a class for this day.</p>
            </div>
        `;
        return;
    }

    container.innerHTML = dayClasses.map((classItem, index) => `
        <div class="class-card" onclick="viewClassDetails(${timetableData.schedule.indexOf(classItem)})">
            <div class="class-time">
                <i class="fas fa-clock"></i>
                ${classItem.time}
            </div>
            <div class="class-info">
                <h4>${classItem.subject}</h4>
                <div class="class-details">
                    <span><i class="fas fa-map-marker-alt"></i> ${classItem.room}</span>
                    ${classItem.professor ? `<span><i class="fas fa-user"></i> ${classItem.professor}</span>` : ''}
                </div>
                ${classItem.notes ? `<p class="class-notes">${classItem.notes}</p>` : ''}
            </div>
            <div class="class-actions">
                <button class="btn-icon" onclick="event.stopPropagation(); editClass(${timetableData.schedule.indexOf(classItem)})">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn-icon" onclick="event.stopPropagation(); deleteClass(${timetableData.schedule.indexOf(classItem)})">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    `).join('');
}

function switchView(view) {
    currentView = view;
    
    document.querySelectorAll('.toggle-btn').forEach(btn => btn.classList.remove('active'));
    document.getElementById(view + 'ViewBtn').classList.add('active');
    
    if (view === 'grid') {
        document.getElementById('gridView').style.display = 'block';
        document.getElementById('listView').style.display = 'none';
        displayGridView();
    } else {
        document.getElementById('gridView').style.display = 'none';
        document.getElementById('listView').style.display = 'block';
        displayListView();
    }
}

function switchDay(day) {
    currentDay = day;
    
    document.querySelectorAll('.day-tab').forEach(tab => tab.classList.remove('active'));
    document.querySelector(`[data-day="${day}"]`).classList.add('active');
    
    displayDaySchedule(day);
}

function addClassAtTime(day, time) {
    document.getElementById('classDay').value = day;
    document.getElementById('classTime').value = time;
    openClassModal();
}

function openClassModal() {
    document.getElementById('classModal').style.display = 'flex';
    document.getElementById('classForm').reset();
    document.getElementById('modalTitle').textContent = editingClass !== null ? 'Edit Class' : 'Add New Class';
    
    if (editingClass !== null) {
        const classData = timetableData.schedule[editingClass];
        document.getElementById('classDay').value = classData.day;
        document.getElementById('classTime').value = classData.time;
        document.getElementById('classSubject').value = classData.subject;
        document.getElementById('classRoom').value = classData.room;
        document.getElementById('classProfessor').value = classData.professor || '';
        document.getElementById('classDuration').value = classData.duration || '60';
        document.getElementById('classNotes').value = classData.notes || '';
    }
}

function closeClassModal() {
    document.getElementById('classModal').style.display = 'none';
    editingClass = null;
}

function editClass(index) {
    editingClass = index;
    openClassModal();
}

function deleteClass(index) {
    if (confirm('Are you sure you want to delete this class?')) {
        timetableData.schedule.splice(index, 1);
        saveTimetable();
        showNotification('Class deleted successfully!', 'success');
    }
}

function viewClassDetails(index) {
    const classData = timetableData.schedule[index];
    if (!classData) return;

    document.getElementById('detailsTitle').textContent = classData.subject;
    document.getElementById('classDetailsContent').innerHTML = `
        <div class="class-details-content">
            <div class="detail-section">
                <h4><i class="fas fa-info-circle"></i> Class Information</h4>
                <div class="detail-grid">
                    <div class="detail-item">
                        <strong>Subject:</strong>
                        <span>${classData.subject}</span>
                    </div>
                    <div class="detail-item">
                        <strong>Day:</strong>
                        <span>${classData.day}</span>
                    </div>
                    <div class="detail-item">
                        <strong>Time:</strong>
                        <span>${classData.time}</span>
                    </div>
                    <div class="detail-item">
                        <strong>Duration:</strong>
                        <span>${classData.duration || 60} minutes</span>
                    </div>
                    <div class="detail-item">
                        <strong>Room:</strong>
                        <span>${classData.room}</span>
                    </div>
                    ${classData.professor ? `
                    <div class="detail-item">
                        <strong>Professor:</strong>
                        <span>${classData.professor}</span>
                    </div>
                    ` : ''}
                </div>
            </div>

            ${classData.notes ? `
            <div class="detail-section">
                <h4><i class="fas fa-sticky-note"></i> Notes</h4>
                <p>${classData.notes}</p>
            </div>
            ` : ''}

            <div class="detail-section">
                <h4><i class="fas fa-cog"></i> Actions</h4>
                <div class="class-actions-detailed">
                    <button class="btn btn-primary" onclick="editClass(${index}); closeClassDetailsModal();">
                        <i class="fas fa-edit"></i> Edit Class
                    </button>
                    <button class="btn btn-secondary" onclick="deleteClass(${index}); closeClassDetailsModal();">
                        <i class="fas fa-trash"></i> Delete Class
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('classDetailsModal').style.display = 'flex';
}

function closeClassDetailsModal() {
    document.getElementById('classDetailsModal').style.display = 'none';
}

document.getElementById('classForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData);
    
    // Check for time conflicts
    const existingClass = timetableData.schedule.find((item, index) => 
        item.day === data.day && 
        item.time === data.time && 
        index !== editingClass
    );
    
    if (existingClass) {
        showNotification('A class is already scheduled at this time!', 'error');
        return;
    }
    
    if (editingClass !== null) {
        // Update existing class
        timetableData.schedule[editingClass] = { ...timetableData.schedule[editingClass], ...data };
        showNotification('Class updated successfully!', 'success');
    } else {
        // Add new class
        if (!timetableData.schedule) {
            timetableData.schedule = [];
        }
        timetableData.schedule.push(data);
        showNotification('Class added successfully!', 'success');
    }
    
    await saveTimetable();
    closeClassModal();
});

async function saveTimetable() {
    try {
        const response = await fetch('/api/timetable', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                user_id: 'default',
                schedule: timetableData.schedule
            })
        });

        if (response.ok) {
            if (currentView === 'grid') {
                displayGridView();
            } else {
                displayListView();
            }
        } else {
            throw new Error('Failed to save timetable');
        }
    } catch (error) {
        console.error('Error saving timetable:', error);
        showNotification('Error saving timetable. Please try again.', 'error');
    }
}



// Close modals when clicking outside
document.getElementById('classModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeClassModal();
    }
});

document.getElementById('classDetailsModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeClassDetailsModal();
    }
});
</script>

<style>
.view-toggle {
    display: flex;
    gap: 10px;
    margin-bottom: 30px;
    justify-content: center;
}

.toggle-btn {
    padding: 10px 20px;
    border: 2px solid #e2e8f0;
    background: white;
    color: #666;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
}

.toggle-btn.active,
.toggle-btn:hover {
    border-color: #667eea;
    background: #667eea;
    color: white;
}

.timetable-container {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    overflow: hidden;
    padding: 20px;
}

.timetable-grid {
    display: grid;
    grid-template-columns: 80px repeat(7, 1fr);
    gap: 1px;
    background: #f0f0f0;
    border-radius: 8px;
    overflow: hidden;
}

.time-header,
.day-header {
    background: #667eea;
    color: white;
    padding: 15px 10px;
    text-align: center;
    font-weight: 600;
}

.time-slot {
    background: #f8fafc;
    padding: 15px 10px;
    text-align: center;
    font-weight: 500;
    color: #666;
}

.class-slot {
    background: white;
    padding: 10px;
    min-height: 60px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
}

.class-slot.empty {
    border: 2px dashed #e2e8f0;
    color: #ccc;
}

.class-slot.empty:hover {
    border-color: #667eea;
    color: #667eea;
    background: #f8fafc;
}

.class-slot.filled {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    text-align: center;
}

.class-slot.filled:hover {
    transform: scale(1.02);
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
}

.class-subject {
    font-weight: 600;
    font-size: 0.9rem;
    margin-bottom: 4px;
}

.class-room {
    font-size: 0.8rem;
    opacity: 0.9;
}

.class-professor {
    font-size: 0.7rem;
    opacity: 0.8;
    margin-top: 2px;
}

.list-container {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    overflow: hidden;
}

.day-tabs {
    display: flex;
    background: #f8fafc;
    border-bottom: 1px solid #e2e8f0;
}

.day-tab {
    flex: 1;
    padding: 15px;
    border: none;
    background: none;
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: 500;
}

.day-tab.active,
.day-tab:hover {
    background: #667eea;
    color: white;
}

.day-schedule {
    padding: 30px;
}

.empty-day {
    text-align: center;
    padding: 60px 20px;
    color: #666;
}

.empty-day i {
    font-size: 4rem;
    margin-bottom: 20px;
    color: #ccc;
}

.empty-day h3 {
    font-size: 1.3rem;
    margin-bottom: 10px;
    color: #333;
}

.class-card {
    display: flex;
    align-items: center;
    gap: 20px;
    padding: 20px;
    border: 1px solid #f0f0f0;
    border-radius: 12px;
    margin-bottom: 15px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.class-card:hover {
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    border-color: #667eea;
    transform: translateY(-2px);
}

.class-time {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 15px;
    border-radius: 8px;
    text-align: center;
    font-weight: 600;
    min-width: 100px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 5px;
}

.class-info {
    flex: 1;
}

.class-info h4 {
    font-size: 1.2rem;
    font-weight: 600;
    margin-bottom: 8px;
    color: #333;
}

.class-details {
    display: flex;
    gap: 20px;
    margin-bottom: 8px;
}

.class-details span {
    display: flex;
    align-items: center;
    gap: 5px;
    color: #666;
    font-size: 0.9rem;
}

.class-details i {
    color: #667eea;
}

.class-notes {
    color: #666;
    font-size: 0.9rem;
    font-style: italic;
    margin: 0;
}

.class-actions {
    display: flex;
    gap: 10px;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
}

.class-details-content {
    padding: 0;
}

.detail-section {
    margin-bottom: 25px;
}

.detail-section h4 {
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 15px;
    color: #333;
    display: flex;
    align-items: center;
    gap: 10px;
}

.detail-section h4 i {
    color: #667eea;
}

.detail-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
}

.detail-grid .detail-item {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.detail-grid .detail-item strong {
    color: #333;
    font-size: 0.9rem;
}

.class-actions-detailed {
    display: flex;
    gap: 15px;
}

@media (max-width: 768px) {
    .timetable-grid {
        grid-template-columns: 60px repeat(7, 1fr);
        font-size: 0.8rem;
    }
    
    .time-header,
    .day-header {
        padding: 10px 5px;
        font-size: 0.8rem;
    }
    
    .class-slot {
        padding: 5px;
        min-height: 50px;
    }
    
    .class-subject {
        font-size: 0.7rem;
    }
    
    .class-room,
    .class-professor {
        font-size: 0.6rem;
    }
    
    .class-card {
        flex-direction: column;
        align-items: stretch;
        gap: 15px;
    }
    
    .class-time {
        min-width: auto;
    }
    
    .class-details {
        flex-direction: column;
        gap: 8px;
    }
    
    .form-row {
        grid-template-columns: 1fr;
    }
    
    .class-actions-detailed {
        flex-direction: column;
    }
}
</style>
{% endblock %}